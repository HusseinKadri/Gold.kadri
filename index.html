<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>أسعار الذهب بالدينار الكويتي — 24/22/21/18</title>
  <style>
  :root{--bg:#f7f7f7;--card:#fff;--text:#111;--muted:#6b7280;--border:#e5e7eb}
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif}
  .container{max-width:820px;margin:24px auto;padding:16px}
  h1{margin:0 0 6px;text-align:center;font-size:clamp(22px,4vw,32px)}
  .meta{text-align:center;color:var(--muted);margin:0 0 16px}
  .price-table{width:100%;border-collapse:collapse;background:var(--card);border-radius:12px;overflow:hidden;box-shadow:0 1px 4px rgba(0,0,0,.05)}
  .price-table th,.price-table td{padding:12px 14px;border-bottom:1px solid var(--border);text-align:center}
  .price-table thead th{background:#f3f4f6;font-weight:600}
  .price-table tbody tr:last-child td{border-bottom:none}
  .err{margin-top:12px;color:#b91c1c;text-align:center;direction:ltr;white-space:pre-wrap}
  </style>
</head>
<body>
  <main class="container">
    <h1>أسعار الذهب بالدينار الكويتي</h1>
    <p class="meta">تحديث كل <strong>10</strong> ثوانٍ • آخر تحديث: <span id="lastUpdate">—</span></p>

    <table class="price-table">
      <thead><tr><th>العيار</th><th>السعر للغرام (د.ك)</th></tr></thead>
      <tbody>
        <tr><td>عيار 24</td><td id="k24">—</td></tr>
        <tr><td>عيار 22</td><td id="k22">—</td></tr>
        <tr><td>عيار 21</td><td id="k21">—</td></tr>
        <tr><td>عيار 18</td><td id="k18">—</td></tr>
      </tbody>
    </table>

    <p id="err" class="err"></p>
  </main>

  <!-- ويدجت صغير مثبت أسفل يمين الصفحة -->
  <div style="position:fixed; bottom:10px; right:10px; z-index:999;">
    <div class="tradingview-widget-container">
      <div class="tradingview-widget-container__widget"></div>
      <script async type="text/javascript"
        src="https://s3.tradingview.com/external-embedding/embed-widget-mini-symbol-overview.js">
      {
        "symbol": "OANDA:XAUUSD",
        "locale": "ar",
        "dateRange": "1D",
        "colorTheme": "light",
        "isTransparent": false,
        "autosize": true,
        "width": 250,
        "height": 150
      }
      </script>
    </div>
  </div>

  <script>
    // مفتاحك لـ exchangerate.host
    const ACCESS_KEY = "68bdef1acfd6647d906618dea32dc23e";

    // نطلب سعر 1 XAU بالدينار (KWD) ثم نحسب الغرامات — لا نعرض سطر الأونصة
    const BASE = "https://api.exchangerate.host/convert";
    const OUNCE_TO_GRAM = 31.1034768;
    const BASE_MS = 10_000; let nextMs = BASE_MS;

    const $$  = (id) => document.getElementById(id);
    const fmt = (n) => (Number.isFinite(n) ? n.toFixed(3) : "—");

    function stamp(){
      const d=new Date(), hh=String(d.getHours()).padStart(2,"0"),
            mm=String(d.getMinutes()).padStart(2,"0"), ss=String(d.getSeconds()).padStart(2,"0");
      $$("lastUpdate").textContent = `${hh}:${mm}:${ss}`;
    }

    async function fetchXauToKwd(){
      const url = `${BASE}?access_key=${ACCESS_KEY}&from=XAU&to=KWD&amount=1&_=${Date.now()}`;
      const r = await fetch(url, { cache:"no-store", mode:"cors", referrerPolicy:"no-referrer" });
      const text = await r.text();
      let data; try { data = JSON.parse(text); } catch { data = { raw:text }; }
      return { ok: r.ok, status: r.status, data };
    }

    function fill(ounceKWD){
      const g24 = ounceKWD / OUNCE_TO_GRAM;
      $$("k24").textContent = fmt(g24);
      $$("k22").textContent = fmt(g24*(22/24));
      $$("k21").textContent = fmt(g24*(21/24));
      $$("k18").textContent = fmt(g24*(18/24));
    }

    async function tick(){
      try{
        const res = await fetchXauToKwd();
        const ounceKWD = Number(res.data?.result);
        if(!res.ok || !Number.isFinite(ounceKWD)){
          throw new Error(`HTTP ${res.status} :: ${JSON.stringify(res.data).slice(0,280)}`);
        }
        fill(ounceKWD);
        $$("err").textContent = "";
        stamp(); nextMs = BASE_MS;
      }catch(e){
        $$("err").textContent = "Error: " + (e?.message || e);
        nextMs = Math.min(nextMs * 2, 60_000);
      }finally{
        setTimeout(tick, nextMs);
      }
    }

    stamp(); tick();
  </script>
</body>
</html>
