<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>أسعار الذهب – دار السبائك</title>
  <meta name="description" content="لوحة تعرض أسعار الذهب من daralsabaek.com عبر عامل Cloudflare (24/22/21/18 وقيمة الأونصة)">
  <style>
    :root{
      --bg: #0b0f14;
      --panel: #121822;
      --muted: #97a3b3;
      --text: #eef3fb;
      --accent: #3aa1ff;
      --danger: #ff5470;
      --warning: #ffc857;
      --success: #2dd4bf;
      --ring: rgba(58,161,255,0.35);
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg: #f6f7fb;
        --panel: #ffffff;
        --muted: #4b5563;
        --text: #0b1322;
        --accent: #2563eb;
        --danger: #dc2626;
        --warning: #b45309;
        --success: #10b981;
        --ring: rgba(37,99,235,0.25);
      }
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,"Noto Naskh Arabic","Noto Sans Arabic",Tahoma,Arial,sans-serif;
    }
    .wrap{max-width:980px; margin:0 auto; padding:24px 16px 60px}
    header{
      display:flex; gap:16px; align-items:center; justify-content:space-between; flex-wrap:wrap; margin-bottom:16px;
    }
    h1{font-size:clamp(20px,3.6vw,28px); margin:0}
    .muted{color:var(--muted)}
    .panel{
      background:var(--panel); border:1px solid rgba(255,255,255,0.06); border-radius:14px; padding:16px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.15), 0 1px 1px rgba(255,255,255,0.03) inset;
    }
    .controls{
      display:grid; gap:12px; grid-template-columns: 1fr;
    }
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .row > *{flex:1 1 auto}
    label{font-size:13px; color:var(--muted)}
    input[type="text"], select{
      width:100%; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.1);
      background:transparent; color:var(--text); outline:none;
    }
    input[type="text"]:focus, select:focus{border-color:var(--accent); box-shadow:0 0 0 3px var(--ring)}
    .switch{display:inline-flex; gap:8px; align-items:center; padding:6px 10px; border-radius:999px; background:rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.08)}
    .switch input{inline-size:18px; block-size:18px}
    button{
      padding:10px 14px; border-radius:10px; border:1px solid rgba(255,255,255,0.1); background:var(--accent); color:#fff; cursor:pointer;
      font-weight:600;
    }
    button.secondary{background:transparent; color:var(--text)}
    button:disabled{opacity:.6; cursor:not-allowed}
    .grid{
      display:grid; gap:12px; grid-template-columns: repeat(auto-fit,minmax(180px,1fr));
      margin-top:14px;
    }
    .card{padding:14px; border-radius:12px; border:1px solid rgba(255,255,255,0.06); background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01))}
    .card h3{margin:0 0 6px 0; font-size:16px}
    .big{font-size:28px; font-variant-numeric:tabular-nums; letter-spacing:.3px}
    .sub{font-size:12px; color:var(--muted)}
    .badges{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px}
    .badge{font-size:11px; padding:4px 8px; border-radius:999px; border:1px solid rgba(255,255,255,0.1)}
    .ok{background:rgba(45,212,191,0.15); border-color:rgba(45,212,191,0.35)}
    .warn{background:rgba(255,200,87,0.15); border-color:rgba(255,200,87,0.35)}
    .err{background:rgba(255,84,112,0.15); border-color:rgba(255,84,112,0.35)}
    .status{display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:10px}
    .chip{font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,0.1)}
    .chip .dot{inline-size:8px; block-size:8px; border-radius:50%; display:inline-block; margin-inline:6px}
    .dot.ok{background:var(--success)} .dot.warn{background:var(--warning)} .dot.err{background:var(--danger)}
    .footer{margin-top:18px; font-size:12px; color:var(--muted)}
    .error{margin-top:10px; padding:12px; border-radius:10px; border:1px solid rgba(255,84,112,0.3); background:rgba(255,84,112,0.08); color:#ffdfe6}
    .row.compact > *{flex:0 0 auto}
    a{color:var(--accent); text-decoration:none} a:hover{text-decoration:underline}
    .skeleton{background:linear-gradient(90deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02), rgba(255,255,255,0.06)); background-size:200% 100%; animation:s 1.2s linear infinite}
    @keyframes s { 0%{background-position:200% 0} 100%{background-position:-200% 0} }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>أسعار الذهب – دار السبائك</h1>
      <div class="muted" id="clock" aria-live="polite"></div>
    </header>

    <section class="panel controls" aria-label="إعدادات الاتصال">
      <div>
        <label for="endpoint">رابط الخدمة (Cloudflare Worker)</label>
        <input id="endpoint" type="text" placeholder="https://your-worker.workers.dev/" value="https://kadri.sfa7000.workers.dev/">
      </div>

      <div class="row">
        <div>
          <label for="page">صفحة داخل الموقع (اختياري)</label>
          <input id="page" type="text" placeholder="/اسعار-الذهب">
        </div>
        <div>
          <label for="interval">تحديث تلقائي</label>
          <select id="interval">
            <option value="0">متوقف</option>
            <option value="30">كل 30 ثانية</option>
            <option value="60" selected>كل دقيقة</option>
            <option value="120">كل دقيقتين</option>
          </select>
        </div>
      </div>

      <div class="row compact">
        <label class="switch"><input id="opt-strict" type="checkbox"> صارم (strict)</label>
        <label class="switch"><input id="opt-derive" type="checkbox" checked> اشتقاق المفقود (derive)</label>
        <label class="switch"><input id="opt-nocache" type="checkbox"> تجاهل كاش المصدر</label>
        <button id="btn-refresh">تحديث الآن</button>
        <button id="btn-json" class="secondary" title="فتح JSON في لسان جديد">عرض JSON</button>
      </div>

      <div class="status" id="status">
        <span class="chip"><span class="dot warn" id="dot"></span><span id="status-text">بانتظار الطلب…</span></span>
        <span class="chip">المصدر: <a id="src-link" href="#" target="_blank" rel="noreferrer">—</a></span>
        <span class="chip">HTTP: <span id="http">—</span></span>
        <span class="chip">آخر تحديث: <span id="updated">—</span></span>
        <span class="chip">الوضع: <span id="partial">—</span></span>
      </div>

      <div id="error" class="error" hidden></div>
    </section>

    <section class="grid" id="cards" aria-label="الأسعار">
      <!-- بطاقات ستُملأ برمجيًا -->
    </section>

    <div class="footer">
      الوحدة: دينار كويتي/غرام، والأونصة: دينار كويتي/أونصة تروي. القيم قد تكون مشتقة إذا لم تتوفر نصًا على الموقع.
    </div>
  </div>

  <script>
    // عناصر DOM
    const els = {
      endpoint: document.getElementById('endpoint'),
      page: document.getElementById('page'),
      interval: document.getElementById('interval'),
      strict: document.getElementById('opt-strict'),
      derive: document.getElementById('opt-derive'),
      nocache: document.getElementById('opt-nocache'),
      btnRefresh: document.getElementById('btn-refresh'),
      btnJSON: document.getElementById('btn-json'),
      statusText: document.getElementById('status-text'),
      dot: document.getElementById('dot'),
      srcLink: document.getElementById('src-link'),
      http: document.getElementById('http'),
      updated: document.getElementById('updated'),
      partial: document.getElementById('partial'),
      error: document.getElementById('error'),
      cards: document.getElementById('cards'),
      clock: document.getElementById('clock'),
    };

    const numFmt = (n) => {
      if (typeof n !== 'number' || !isFinite(n)) return '—';
      try { return n.toLocaleString('ar', { minimumFractionDigits: 3, maximumFractionDigits: 3 }); }
      catch { return (Math.round(n*1000)/1000).toString(); }
    };

    function savePrefs(){
      const prefs = {
        endpoint: els.endpoint.value.trim(),
        page: els.page.value.trim(),
        interval: els.interval.value,
        strict: els.strict.checked,
        derive: els.derive.checked,
        nocache: els.nocache.checked,
      };
      localStorage.setItem('gold-ui-prefs', JSON.stringify(prefs));
      return prefs;
    }
    function loadPrefs(){
      try {
        const p = JSON.parse(localStorage.getItem('gold-ui-prefs') || '{}');
        if (p.endpoint) els.endpoint.value = p.endpoint;
        if (p.page) els.page.value = p.page;
        if (p.interval) els.interval.value = p.interval;
        if (typeof p.strict === 'boolean') els.strict.checked = p.strict;
        if (typeof p.derive === 'boolean') els.derive.checked = p.derive;
        if (typeof p.nocache === 'boolean') els.nocache.checked = p.nocache;
      } catch {}
    }
    loadPrefs();

    function setStatus(kind, text){
      els.statusText.textContent = text;
      if (kind === 'ok'){ els.dot.className = 'dot ok'; }
      else if (kind === 'warn'){ els.dot.className = 'dot warn'; }
      else { els.dot.className = 'dot err'; }
    }

    function buildURL(openInNewTab = false){
      const base = els.endpoint.value.trim().replace(/\s+/g,'');
      const u = new URL(base);
      if (els.page.value.trim()) u.searchParams.set('page', els.page.value.trim());
      u.searchParams.set('strict', els.strict.checked ? '1' : '0');
      u.searchParams.set('derive', els.derive.checked ? '1' : '0');
      if (els.nocache.checked) u.searchParams.set('nocache','1');
      return u.toString();
    }

    function renderSkeleton(){
      els.cards.innerHTML = `
        ${['24','22','21','18','أونصة'].map(k => `
          <div class="card">
            <h3>${k === 'أونصة' ? 'سعر الأونصة' : 'عيار ' + k}</h3>
            <div class="big skeleton" style="height:34px;border-radius:8px"></div>
            <div class="sub skeleton" style="height:14px;width:60%;margin-top:8px;border-radius:6px"></div>
          </div>
        `).join('')}
      `;
    }

    function renderData(d){
      const hasMD = d && typeof d.measured === 'object' && typeof d.derived === 'object';
      const mkBadges = (key) => {
        if (!hasMD) return '';
        const m = d.measured[key] ? '<span class="badge ok">مقاس</span>' : '';
        const r = d.derived[key] ? '<span class="badge warn">مشتق</span>' : '';
        return `<div class="badges">${m || r ? (m + r) : ''}</div>`;
        };
      els.cards.innerHTML = `
        <div class="card">
          <h3>عيار 24</h3>
          <div class="big">${numFmt(d.k24)} <span class="sub">د.ك / غ</span></div>
          ${mkBadges('24')}
        </div>
        <div class="card">
          <h3>عيار 22</h3>
          <div class="big">${numFmt(d.k22)} <span class="sub">د.ك / غ</span></div>
          ${mkBadges('22')}
        </div>
        <div class="card">
          <h3>عيار 21</h3>
          <div class="big">${numFmt(d.k21)} <span class="sub">د.ك / غ</span></div>
          ${mkBadges('21')}
        </div>
        <div class="card">
          <h3>عيار 18</h3>
          <div class="big">${numFmt(d.k18)} <span class="sub">د.ك / غ</span></div>
          ${mkBadges('18')}
        </div>
        <div class="card">
          <h3>سعر الأونصة</h3>
          <div class="big">${numFmt(d.ounce)} <span class="sub">د.ك / أونصة تروي</span></div>
          ${mkBadges('ounce')}
        </div>
      `;
    }

    function showError(msg, details){
      els.error.hidden = false;
      els.error.innerHTML = `<strong>خطأ:</strong> ${msg || 'حدث خطأ غير متوقع.'}${details ? `<br><small class="muted">${details}</small>` : ''}`;
      setStatus('err', 'فشل الجلب');
    }

    function clearError(){ els.error.hidden = true; els.error.textContent = ''; }

    function fmtTime(iso){
      if (!iso) return '—';
      try {
        const d = new Date(iso);
        const f = new Intl.DateTimeFormat('ar', { dateStyle:'medium', timeStyle:'medium' });
        return f.format(d);
      } catch { return iso; }
    }

    async function fetchNow(){
      clearError(); renderSkeleton(); savePrefs();
      const url = buildURL();
      els.btnRefresh.disabled = true;
      setStatus('warn','جارٍ الجلب…');

      try {
        const res = await fetch(url, { method:'GET' });
        els.http.textContent = res.status;
        let data;
        try { data = await res.json(); } catch { data = null; }

        // عالج أخطاء الـJSON القياسية من العامل
        if (!res.ok || (data && data.error)) {
          const note = data && (data.note || data.error);
          showError(data?.error || `HTTP ${res.status}`, note);
          els.srcLink.href = data?.source || buildURL(true);
          els.srcLink.textContent = data?.source || '—';
          els.updated.textContent = data?.updatedAt ? fmtTime(data.updatedAt) : '—';
          els.partial.textContent = '—';
          return;
        }

        // نجاح
        setStatus('ok','تم التحديث');
        els.srcLink.href = data.source || '#';
        els.srcLink.textContent = data.source || '—';
        els.updated.textContent = data.updatedAt ? fmtTime(data.updatedAt) : '—';
        els.partial.textContent = data.partial ? 'جزئي' : 'كامل';
        els.partial.parentElement.className = 'chip ' + (data.partial ? 'warn' : '');

        renderData(data);
      } catch (err){
        showError('تعذر الاتصال بالخدمة', String(err?.message || err));
      } finally {
        els.btnRefresh.disabled = false;
      }
    }

    // JSON في لسان جديد مع نفس البراميتر
    function openJSON(){
      const u = buildURL(true);
      window.open(u, '_blank', 'noopener,noreferrer');
    }

    // ساعة بسيطة
    setInterval(() => {
      try {
        els.clock.textContent = new Intl.DateTimeFormat('ar', { hour:'2-digit', minute:'2-digit', second:'2-digit' }).format(new Date());
      } catch {
        const d = new Date();
        els.clock.textContent = d.toLocaleTimeString();
      }
    }, 500);

    // ربط الأحداث
    els.btnRefresh.addEventListener('click', fetchNow);
    els.btnJSON.addEventListener('click', openJSON);
    els.interval.addEventListener('change', setupAuto);
    [els.endpoint, els.page, els.strict, els.derive, els.nocache].forEach(el => {
      el.addEventListener('change', () => { savePrefs(); });
      el.addEventListener('blur', () => { savePrefs(); });
    });

    // تحديث تلقائي
    let timer = null;
    function setupAuto(){
      if (timer) clearInterval(timer);
      const sec = parseInt(els.interval.value, 10) || 0;
      if (sec > 0){
        timer = setInterval(fetchNow, sec*1000);
      }
    }

    // أول تحميل
    renderSkeleton();
    fetchNow();
    setupAuto();
  </script>
</body>
</html>
