export default {
  async fetch(req) {
    const H = {
      "content-type": "application/json; charset=utf-8",
      "access-control-allow-origin": "*",
      "access-control-allow-methods": "GET, OPTIONS",
      "access-control-allow-headers": "Content-Type"
    };
    if (req.method === "OPTIONS") return new Response(null, { headers: H });

    const okNum = (x) => Number.isFinite(x) && x > 0;
    const toNum = (s) =>
      Number(String(s).replace(/[^\d.,]/g, "").replace(/,/g, "").replace(/(\d+)\.(\d+)\.(\d+)/, "$1.$2$3"));

    const RE = {
      k24: [
        /karat\s*24\s*\(Gm\)\s*([\d.,]+)\s*KWD/i,
        /عيار\s*24[\s\S]{0,80}?([\d.,]+)\s*(?:د\.?ك|KWD)/i
      ],
      k22: [
        /karat\s*22\s*\(Gm\)\s*([\d.,]+)\s*KWD/i,
        /عيار\s*22[\s\S]{0,80}?([\d.,]+)\s*(?:د\.?ك|KWD)/i
      ],
      k21: [
        /karat\s*21\s*\(Gm\)\s*([\d.,]+)\s*KWD/i,
        /عيار\s*21[\s\S]{0,80}?([\d.,]+)\s*(?:د\.?ك|KWD)/i
      ],
      k18: [
        /karat\s*18\s*\(Gm\)\s*([\d.,]+)\s*KWD/i,
        /عيار\s*18[\s\S]{0,80}?([\d.,]+)\s*(?:د\.?ك|KWD)/i
      ],
    };

    const extract = (html) => {
      const take = (arr) => {
        for (const re of arr) {
          const m = html.match(re);
          if (m) {
            const n = toNum(m[1]);
            if (okNum(n)) return n;
          }
        }
        return NaN;
      };
      return { k24: take(RE.k24), k22: take(RE.k22), k21: take(RE.k21), k18: take(RE.k18) };
    };

    const sources = [
      "https://daralsabaek.com/home",      // ما طلبته
      "https://daralsabaek.com/",          // الصفحة الرئيسية
      "https://daralsabaek.com/gold-calculator",
      "https://daralsabaek.com/chart"
    ];

    // جرّب المصادر بالتتابع حتى تحصل على أرقام صحيحة
    for (const src of sources) {
      try {
        const r = await fetch(src, { cf: { cacheTtl: 8, cacheEverything: true } });
        if (!r.ok) continue;
        const html = await r.text();
        const rates = extract(html);
        if ([rates.k24, rates.k22, rates.k21, rates.k18].every(okNum)) {
          return new Response(JSON.stringify({ source: src, updatedAt: new Date().toISOString(), rates }), { headers: H });
        }
      } catch (_) {}
    }

    // احتياط حكومي لو فشلت كل الصفحات
    try {
      const r2 = await fetch("https://www.moci.gov.kw/ar/market-prices/gold/", { cf: { cacheTtl: 30, cacheEverything: true } });
      const html2 = await r2.text();
      const grab = (label) => {
        const m = html2.match(new RegExp(label + "[\\s\\S]{0,120}?(\\d+[\\.,]\\d+)", "im"));
        return m ? toNum(m[1]) : NaN;
      };
      const rates = { k24: grab("عيار\\s*24"), k22: grab("عيار\\s*22"), k21: grab("عيار\\s*21"), k18: grab("عيار\\s*18") };
      if ([rates.k24, rates.k22, rates.k21, rates.k18].every(okNum)) {
        return new Response(JSON.stringify({ source: "https://www.moci.gov.kw/ar/market-prices/gold/", updatedAt: new Date().toISOString(), rates }), { headers: H });
      }
    } catch (_) {}

    return new Response(JSON.stringify({ error: "parse_failed" }), { status: 502, headers: H });
  }
};
