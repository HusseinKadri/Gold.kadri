<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>أسعار الذهب بالدينار الكويتي</title>
  <style>
    :root{--bg:#0b0f14;--card:#131a22;--text:#e9eef3;--muted:#9fb0c0;--accent:#13c2c2;--bad:#ff6b6b}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:16px/1.6 system-ui,Segoe UI,Roboto,Arial}
    .container{max-width:1100px;margin:0 auto;padding:24px}
    h1{margin:0 0 6px;font-weight:700}
    .sub{color:var(--muted);font-size:.95rem}
    .grid{display:grid;gap:16px;grid-template-columns:1fr}
    @media(min-width:900px){.grid{grid-template-columns:1.1fr .9fr}}
    .card{background:var(--card);border:1px solid #1d2632;border-radius:14px;padding:16px}
    .kpi{display:flex;justify-content:space-between;align-items:center;border-bottom:1px dashed #223140;padding-bottom:10px;margin-bottom:12px}
    .kpi strong{font-size:1.05rem}
    .status{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .pill{padding:4px 10px;border:1px solid #203243;border-radius:999px;color:var(--muted);font-size:.9rem}
    .blink{display:inline-block;width:8px;height:8px;border-radius:50%;background:var(--accent);box-shadow:0 0 8px var(--accent)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 12px;border-bottom:1px solid #1f2a36;text-align:start}
    th{color:var(--muted);font-weight:600}
    td.amount{font-variant-numeric:tabular-nums}
    .footnote{color:var(--muted);font-size:.9rem;margin-top:10px}
    .err{color:var(--bad);font-size:.95rem;margin-top:6px}
    .tv-wrap{display:grid;gap:12px}
  </style>
</head>
<body>
  <div class="container">
    <h1>أسعار الذهب بالدينار الكويتي</h1>
    <div class="sub">
      تحديث تلقائي كل 10 ثوانٍ • آخر تحديث: <span id="last-updated">—</span>
    </div>

    <div class="grid" style="margin-top:18px">
      <!-- العمود الأيسر: الجداول والحساب -->
      <section class="card">
        <div class="kpi">
          <strong>الأسعار المحسوبة (KWD)</strong>
          <div class="status">
            <span class="pill">XAU → KWD (via api.exchangerate.host)</span>
            <span class="pill"><span class="blink"></span> مباشر</span>
          </div>
        </div>

        <table>
          <thead>
            <tr>
              <th>الوحدة</th>
              <th>السعر (د.ك)</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>أونصة الذهب</td>
              <td id="oz" class="amount">—</td>
            </tr>
            <tr>
              <td>غرام عيار 24</td>
              <td id="g24" class="amount">—</td>
            </tr>
            <tr>
              <td>غرام عيار 22</td>
              <td id="g22" class="amount">—</td>
            </tr>
            <tr>
              <td>غرام عيار 21</td>
              <td id="g21" class="amount">—</td>
            </tr>
            <tr>
              <td>غرام عيار 18</td>
              <td id="g18" class="amount">—</td>
            </tr>
          </tbody>
        </table>

        <div id="error" class="err" style="display:none"></div>

        <div class="footnote">
          المصدر البرمجي: <code>api.exchangerate.host/convert?from=XAU&amp;to=KWD</code>.
          الحساب: 1 أونصة تروي = 31.1034768 غرام. العيارات = (العيار/24) × سعر غرام 24.
        </div>
      </section>

      <!-- العمود الأيمن: TradingView -->
      <section class="card">
        <div class="kpi" style="margin-bottom:4px">
          <strong>العرض البصري من TradingView</strong>
        </div>
        <div class="tv-wrap">
          <!-- XAU/USD -->
          <div class="tradingview-widget-container">
            <div class="tradingview-widget-container__widget"></div>
            <script
              type="text/javascript"
              src="https://s3.tradingview.com/external-embedding/embed-widget-mini-symbol-overview.js"
              async>
              {
                "symbol": "OANDA:XAUUSD",
                "locale": "ar_AE",
                "dateRange": "1M",
                "height": 220,
                "width": "100%",
                "colorTheme": "dark"
              }
            </script>
          </div>

          <!-- USD/KWD -->
          <div class="tradingview-widget-container">
            <div class="tradingview-widget-container__widget"></div>
            <script
              type="text/javascript"
              src="https://s3.tradingview.com/external-embedding/embed-widget-mini-symbol-overview.js"
              async>
              {
                "symbol": "FX_IDC:USDKWD",
                "locale": "ar_AE",
                "dateRange": "1M",
                "height": 220,
                "width": "100%",
                "colorTheme": "dark"
              }
            </script>
          </div>
        </div>
      </section>
    </div>

    <div class="footnote" style="margin-top:14px">
      تلميح: إذا لم يظهر أحد الودجات، قد يحتاج الرمز (Ticker) للتعديل حسب مزوّد البيانات المسموح في بلدك.
    </div>
  </div>

  <script>
    // ثوابت
    const OUNCE_TO_GRAMS = 31.1034768;
    const API_XAU_KWD = "https://api.exchangerate.host/convert?from=XAU&to=KWD&amount=1";
    const API_XAU_USD = "https://api.exchangerate.host/convert?from=XAU&to=USD&amount=1";
    const API_USD_KWD = "https://api.exchangerate.host/convert?from=USD&to=KWD&amount=1";

    // عناصر DOM
    const el = {
      oz:  document.getElementById("oz"),
      g24: document.getElementById("g24"),
      g22: document.getElementById("g22"),
      g21: document.getElementById("g21"),
      g18: document.getElementById("g18"),
      last: document.getElementById("last-updated"),
      err: document.getElementById("error"),
    };

    function formatKWD(v){
      try {
        return new Intl.NumberFormat('ar-KW', { style: 'currency', currency: 'KWD', maximumFractionDigits: 3 }).format(v);
      } catch {
        return (v?.toFixed?.(3) ?? v) + " د.ك";
      }
    }

    function kwNow(){
      const d = new Date();
      return d.toLocaleString('ar-KW', {
        timeZone: 'Asia/Kuwait', hour12: false,
        year:'numeric', month:'2-digit', day:'2-digit',
        hour:'2-digit', minute:'2-digit', second:'2-digit'
      });
    }

    function setPlaceholders(){
      el.oz.textContent  = '—';
      el.g24.textContent = '—';
      el.g22.textContent = '—';
      el.g21.textContent = '—';
      el.g18.textContent = '—';
    }

    async function fetchJson(url){
      const u = url + "&_=" + Date.now(); // منع الكاش
      const r = await fetch(u, { cache: "no-store" });
      if (!r.ok) throw new Error("HTTP " + r.status);
      return r.json();
    }

    async function getOunceKwd(){
      // 1) المحاولة المباشرة XAU→KWD
      try {
        const j = await fetchJson(API_XAU_KWD);
        if (j && typeof j.result === 'number' && isFinite(j.result) && j.result > 0) return j.result;
      } catch (e) {/* fallthrough */}

      // 2) بديل: XAU→USD ثم USD→KWD
      try {
        const [xauUsd, usdKwd] = await Promise.all([fetchJson(API_XAU_USD), fetchJson(API_USD_KWD)]);
        const a = xauUsd?.result, b = usdKwd?.result;
        if ([a,b].every(n => typeof n === 'number' && isFinite(n) && n > 0)) return a * b;
        throw new Error("fallback invalid");
      } catch (e) {
        throw new Error("تعذّر جلب السعر من api.exchangerate.host");
      }
    }

    function compute(perOunceKwd){
      const gram24 = perOunceKwd / OUNCE_TO_GRAMS;
      const as = (x)=> Number(x.toFixed(3));
      return {
        oz: as(perOunceKwd),
        g24: as(gram24 * (24/24)),
        g22: as(gram24 * (22/24)),
        g21: as(gram24 * (21/24)),
        g18: as(gram24 * (18/24)),
      };
    }

    async function update(){
      el.err.style.display = 'none';
      try {
        const ozKwd = await getOunceKwd();
        const r = compute(ozKwd);
        el.oz.textContent  = formatKWD(r.oz);
        el.g24.textContent = formatKWD(r.g24);
        el.g22.textContent = formatKWD(r.g22);
        el.g21.textContent = formatKWD(r.g21);
        el.g18.textContent = formatKWD(r.g18);
        el.last.textContent = kwNow();
      } catch (e){
        el.err.textContent = (e && e.message) ? e.message : 'خطأ غير متوقع أثناء التحديث.';
        el.err.style.display = 'block';
        setPlaceholders();
      }
    }

    // تحديث أولي وInterval كل 10 ثوانٍ
    update();
    setInterval(update, 10_000);
  </script>
</body>
</html>
